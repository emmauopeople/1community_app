name: CD

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: 1community-app-backend
  FRONTEND_IMAGE_NAME: 1community-app-frontend
  GITOPS_REPO: 1community_deployment_configurations
  GITOPS_BACKEND_FILE: apps/community-backend/kustomization.yaml
  GITOPS_FRONTEND_FILE: apps/community-frontend/kustomization.yaml

jobs:
  build-push-and-bump-gitops:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout application repo (this repo)
      - name: Checkout app repo
        uses: actions/checkout@v4

      # 2) Set immutable image tag
      - name: Set image tag
        run: echo "IMAGE_TAG=sha-${GITHUB_SHA}" >> $GITHUB_ENV

      # 3) Login to GitHub Container Registry
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4) Build & push backend image
      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
      # 4b) Build & push frontend image
      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      # 5) Checkout GitOps repo (separate repo)
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/${{ env.GITOPS_REPO }}
          token: ${{ secrets.DEPLOY_REPO_TOKEN }}
          path: gitops

      # 6) Update image tag in GitOps repo (robust + debug)
      - name: Update backend image tag in GitOps repo
        shell: bash
        run: |
          set -euo pipefail

          echo "IMAGE_TAG=${IMAGE_TAG}"
          backend_file="gitops/${GITOPS_BACKEND_FILE}"
          frontend_file="gitops/${GITOPS_FRONTEND_FILE}"

          for f in "$backend_file" "$frontend_file"; do
            if [ ! -f "$f" ]; then
                echo "ERROR: $f not found."
              exit 1
            fi
          done

          

          # Replace the entire newTag line, preserving indentation
          sed -i -E "s|^([[:space:]]*newTag:[[:space:]]*).*$|\1${IMAGE_TAG}|" "$backend_file"
          sed -i -E "s|^([[:space:]]*newTag:[[:space:]]*).*$|\1${IMAGE_TAG}|" "$frontend_file"

          

          echo "---- DIFF ----"
          git -C gitops diff -- "${GITOPS_BACKEND_FILE}" || true
          git -C gitops diff -- "${GITOPS_FRONTEND_FILE}" || true

          # Stage the change
          git -C gitops add "${GITOPS_BACKEND_FILE}"
          git -C gitops add "${GITOPS_FRONTEND_FILE}"
          git -C gitops status

      # 7) Create a PR to GitOps repo
      - name: Create PR to GitOps repo
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.DEPLOY_REPO_TOKEN }}
          path: gitops
          commit-message: "chore: bump backend image to ${{ env.IMAGE_TAG }}"
          title: "Deploy backend ${{ env.IMAGE_TAG }}"
          body: |
            Automated image bump from 1community_app.
            Image: `${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}`
          branch: "deploy/backend-${{ env.IMAGE_TAG }}"
          base: "main"
          delete-branch: true
